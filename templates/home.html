<!-- templates/home.html -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Return to Office Helper</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Include jQuery for simplicity (optional: use vanilla JS or another library) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <!-- Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
</head>

<body>
    <h1 style="text-align: center;">Return to Office Calendar</h1>

    <!-- Navigation Links with Current Month and Year -->
    <div class="navigation">
        <span style="font-size: 1.2em; font-weight: bold;">{{.CurrentDate.Format "January 2006"}}</span>
        <br>
        <!-- Previous Month -->
        <a href="/?year={{.PrevMonth.year}}&month={{.PrevMonth.month}}&day={{.PrevMonth.day}}">&laquo; Previous
            Month</a>

        <!-- Next Month -->
        <a href="/?year={{.NextMonth.year}}&month={{.NextMonth.month}}&day={{.NextMonth.day}}">Next Month &raquo;</a>
    </div>

    <!-- Display In-Office Average -->
    <!-- Display In-Office Average -->
    <div class="attendance-average" style="text-align: center; margin-bottom: 20px;">
        <h3 id="average-days">In-Office Average Days for Q4 (Oct 1 - Dec 31): {{printf "%.2f" .AverageDays}} Days per
            Week</h3>
        <p id="counts">In-Office Days: {{.InOfficeCount}} / Total Days: {{.TotalDays}}</p>

        <!-- Optional: Progress Bar -->
        <div class="progress-bar-container" style="width: 50%; margin: 10px auto;">
            <div class="progress-bar" style="width: 100%; background-color: #e0e0e0; border-radius: 5px;">
                <div id="progress-fill" class="progress-fill" style="
                width: {{.Average}}%;
                background-color: #4CAF50;
                height: 20px;
                border-radius: 5px;
                transition: width 0.5s ease;
            "></div>
            </div>
            <p id="progress-percent" style="margin-top: 5px;">{{printf "%.2f" .Average}}% In Office</p>
        </div>
    </div>

    <!-- Display Success Message -->
    {{if .Message}}
    <div class="message" style="text-align: center; color: green; margin-bottom: 20px;">
        <p>{{.Message}}</p>
    </div>
    {{end}}

    <!-- Action Buttons -->
    <div class="action-buttons" style="text-align: center; margin: 20px 0;">
        <button onclick="window.location.href='/add-event'" style="padding: 10px 20px; margin-right: 10px;">Add
            Event</button>
        <button onclick="window.location.href='/events'" style="padding: 10px 20px;">Events</button>
        <button onclick="window.location.href='/prefs'" style="padding: 10px 20px;">Prefs</button>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <span class="legend-color holiday"></span> Holiday
        </div>
        <div class="legend-item">
            <span class="legend-color vacation"></span> Vacation
        </div>
        <div class="legend-item">
            <span class="legend-color in-office"></span> In Office
        </div>
        <div class="legend-item">
            <span class="legend-color remote"></span> Remote
        </div>
        <div class="legend-item">
            <span class="legend-color weekend"></span> Weekend
        </div>
    </div>

    <!-- Calendar Table -->
    <table class="calendar">
        <tr>
            <th>Sun</th>
            <th>Mon</th>
            <th>Tue</th>
            <th>Wed</th>
            <th>Thu</th>
            <th>Fri</th>
            <th>Sat</th>
        </tr>
        {{range .Weeks}}
        <tr>
            {{range .}}
            <td class="
                {{if not .InMonth}}not-current-month{{end}} 
                {{if .Today}}today{{end}} 
                {{if .IsWeekend}}weekend{{end}}">
                <div>{{.Date.Day}}</div>
                {{if .Events}}
                <div class="events">
                    {{range .Events}}
                    {{if eq .Type "holiday"}}
                    <span class="event-holiday"><i class="fa-solid fa-umbrella-beach"></i>{{.Description}}</span>
                    {{else if eq .Type "vacation"}}
                    <span class="event-vacation"><i class="fa-solid fa-plane"></i>{{.Description}}</span>
                    {{else if eq .Type "attendance"}}
                    <span class="toggle-attendance {{if .IsInOffice}}event-in-office{{else}}event-remote{{end}}"
                        data-date="{{.Date.Format "2006-01-02"}}"
                        data-status="{{if .IsInOffice}}in{{else}}remote{{end}}">
                        {{if .IsInOffice}}<i class="fa-solid fa-building"></i> In Office{{else}}<i
                            class="fa-solid fa-home"></i> Remote{{end}}
                    </span>
                    {{end}}
                    {{end}}
                </div>
                {{end}}
            </td>
            {{end}}
        </tr>
        {{end}}
    </table>

    <!-- Legend for Toggle -->
    <div class="legend">
        <div class="legend-item">
            <span class="legend-color toggle-success"></span> Toggled Successfully
        </div>
        <div class="legend-item">
            <span class="legend-color toggle-failure"></span> Toggle Failed
        </div>
    </div>

    <!-- JavaScript for Toggling Attendance -->
    <script>
        $(document).ready(function () {
            // Handle click on attendance toggle
            $('.toggle-attendance').on('click', function () {
                var span = $(this);
                var date = span.data('date');
                var currentStatus = span.data('status'); // 'in' or 'remote'
                var newStatus = currentStatus === 'in' ? 'remote' : 'in';

                // Send AJAX POST request to toggle attendance
                $.ajax({
                    url: '/toggle-attendance',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ date: date }),
                    success: function (response) {
                        if (response.success) {
                            console.log("Success:", response)
                            // Update the span's class and text
                            if (response.newStatus === 'in') {
                                span.removeClass('event-remote').addClass('event-in-office');
                                span.html('<i class="fa-solid fa-building"></i> In Office');
                                span.data('status', 'in');
                            } else {
                                span.removeClass('event-in-office').addClass('event-remote');
                                span.html('<i class="fa-solid fa-home"></i> Remote');
                                span.data('status', 'remote');
                            }

                                     // Update counts and averages
                        $('#average-days').text('In-Office Average Days for Q4 (Oct 1 - Dec 31): ' + response.averageDays.toFixed(2) + ' Days per Week');
                        $('#counts').text('In-Office Days: ' + response.inOfficeCount + ' / Total Days: ' + response.totalDays);
                        $('#progress-fill').css('width', response.average + '%');
                        $('#progress-fill').css('background-color', '#4CAF50'); // Optional: Change color based on status
                        $('#progress-percent').text(response.average.toFixed(2) + '% In Office');

                            // Optionally, show a success message using Toastr
                            toastr.success('Attendance status updated successfully.');
                        } else {
                            // Optionally, show an error message using Toastr
                            toastr.error('Failed to update attendance status: ' + response.message);
                        }
                    },
                    error: function () {
                        toastr.error('An error occurred while updating attendance status.');
                    }
                });
            });
        });
    </script>
</body>

</html>