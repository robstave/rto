<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Return to Office Helper</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Include jQuery for simplicity (optional: use vanilla JS or another library) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <!-- Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
</head>

<body>
    <h1 style="text-align: center;">Return to Office Calendar</h1>

    <!-- Navigation Links with Current Month and Year -->
    <div class="navigation">
        <!-- Previous Month -->
        <a href="/?year={{.PrevMonth.year}}&month={{.PrevMonth.month}}&day={{.PrevMonth.day}}">&laquo; Previous Month</a>

        <!-- Current Month -->
        <span class="current-month">{{.CurrentDate.Format "January 2006"}}</span>

        <!-- Next Month -->
        <a href="/?year={{.NextMonth.year}}&month={{.NextMonth.month}}&day={{.NextMonth.day}}">Next Month &raquo;</a>
    </div>

    <!-- Display In-Office Average -->
    <div class="attendance-average" style="text-align: center; margin-bottom: 120px;">
        <h3 id="average-days">In-Office Average Days for Q4 (Oct 1 - Dec 31): {{printf "%.2f" .AverageDays}} Days per Week</h3>
        <p id="counts">In-Office Days: {{.InOfficeCount}} / Total Days: {{.TotalDays}} / Target Days: {{.TargetDays}} </p>

        <div class="progress-bar-container">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
        </div>
    </div>
 

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <span class="legend-color holiday"></span> Holiday
        </div>
        <div class="legend-item">
            <span class="legend-color vacation"></span> Vacation
        </div>
        <div class="legend-item">
            <span class="legend-color in-office"></span> In Office
        </div>
        <div class="legend-item">
            <span class="legend-color remote"></span> Remote
        </div>
        <div class="legend-item">
            <span class="legend-color weekend"></span> Weekend
        </div>
    </div>

    <!-- Calendar Table -->
    <table class="calendar">
        <tr>
            <th>Sun</th>
            <th>Mon</th>
            <th>Tue</th>
            <th>Wed</th>
            <th>Thu</th>
            <th>Fri</th>
            <th>Sat</th>
        </tr>
        {{range .Weeks}}
        <tr>
            {{range .}}
            <td class="
                {{if not .InMonth}}not-current-month{{end}} 
                {{if .Today}}today{{end}} 
                {{if .IsWeekend}}weekend{{end}}">
                <div>{{.Date.Day}}</div>
                {{if .Events}}
                <div class="events">
                    {{range .Events}}
                    {{if eq .Type "holiday"}}
                    <span class="event-holiday"><i class="fa-solid fa-umbrella-beach"></i>{{.Description}}</span>
                    {{else if eq .Type "vacation"}}
                    <span class="event-vacation"><i class="fa-solid fa-plane"></i>{{.Description}}</span>
                    {{else if eq .Type "attendance"}}
                    <span class="toggle-attendance {{if .IsInOffice}}event-in-office{{else}}event-remote{{end}}"
                        data-date="{{.Date.Format "2006-01-02"}}"
                        data-status="{{if .IsInOffice}}in{{else}}remote{{end}}">
                        {{if .IsInOffice}}<i class="fa-solid fa-building"></i> In Office{{else}}<i class="fa-solid fa-home"></i> Remote{{end}}
                    </span>
                    {{end}}
                    {{end}}
                </div>
                {{end}}
            </td>
            {{end}}
        </tr>
        {{end}}
    </table>

    <!-- Action Buttons -->
    <div class="action-buttons" style="text-align: center; margin: 20px 0;">
        <button onclick="window.location.href='/add-event'" style="padding: 10px 20px; margin-right: 10px;">Add Event</button>
        <button onclick="window.location.href='/events'" style="padding: 10px 20px; margin-right: 10px;">Events</button>
        <button onclick="window.location.href='/prefs'" style="padding: 10px 20px; margin-right: 10px;">Prefs</button>
        <!-- **New Export Button** -->
        <button onclick="window.location.href='/export/markdown'" style="padding: 10px 20px;">Export as Markdown</button>
    </div>

    <!-- JavaScript for Toggling Attendance and Updating Progress Bar -->
    <script>
        $(document).ready(function () {
            // Function to initialize the progress bar
            function initializeProgressBar(averagePercent,targetDays) {
                $('#progress-fill').css('width', averagePercent + '%');     

                // color is determined by 2 rules
                // 2 and under is red...bad
                // A targetDays is in the prefs.  Some folks target 2.5 days
                // under the target is yellow.  Above is Green
                if ((averagePercent * 7.0/100.0) < 2) {
                    $('#progress-fill').css('background-color', '#F44336'); // Red
                } else if ((averagePercent * 7.0/100.0) < targetDays) {
                    $('#progress-fill').css('background-color', '#FFC107'); // Yellow
                } else {
                    $('#progress-fill').css('background-color', '#4CAF50'); // Green
                }
            }
  
            initializeProgressBar(initialAverage, targetDays);

            // Handle click on attendance toggle
            $('.toggle-attendance').on('click', function () {
                var span = $(this);
                var date = span.data('date');
                var currentStatus = span.data('status'); // 'in' or 'remote'

                // Send AJAX POST request to toggle attendance
                $.ajax({
                    url: '/toggle-attendance',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ date: date }),
                    success: function (response) {
                        if (response.success) {
                            console.log("Success:", response);
                            // Update the span's class and text
                            if (response.newStatus === 'in') {
                                span.removeClass('event-remote').addClass('event-in-office');
                                span.html('<i class="fa-solid fa-building"></i> In Office');
                                span.data('status', 'in');
                            } else {
                                span.removeClass('event-in-office').addClass('event-remote');
                                span.html('<i class="fa-solid fa-home"></i> Remote');
                                span.data('status', 'remote');
                            }

                            // Update counts and averages
                            var averageDays = parseFloat(response.averageDays).toFixed(2);
                            var targetDays = parseFloat(response.targetDays).toFixed(2);
                            var inOfficeCount = response.inOfficeCount;
                            var totalDays = response.totalDays;
                            var averagePercent = ((parseFloat(inOfficeCount) / parseFloat(totalDays)) * 100).toFixed(2);

                            $('#average-days').text('In-Office Average Days for Q4 (Oct 1 - Dec 31): ' + averageDays + ' Days per Week');
                            $('#counts').text('In-Office Days: ' + inOfficeCount + ' / Total Days: ' + totalDays  + ' / Target Days: ' + targetDays);
                            initializeProgressBar(averagePercent,targetDays);

                            // Optionally, show a success message using Toastr
                            toastr.success('Attendance status updated successfully.');
                        } else {
                            // Optionally, show an error message using Toastr
                            toastr.error('Failed to update attendance status: ' + response.message);
                        }
                    },
                    error: function () {
                        toastr.error('An error occurred while updating attendance status.');
                    }
                });
            });
        });
    </script>
</body>

</html>
